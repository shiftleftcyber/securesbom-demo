name: SecureSBOM Demo - Tamper Detection & Quality Gate (Maven)

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  # --------------------------------------------------
  # 1ï¸âƒ£ Build & Test
  # --------------------------------------------------
  build:
    name: ðŸ—ï¸ Build & Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Build & Test with Maven
        run: mvn -B clean verify -DskipTests
        shell: bash

      - name: Upload Build Artifacts (for next stage)
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: target/

      - name: Add Job Summary
        run: |
          echo "### ðŸ—ï¸ Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "- Maven project built successfully" >> $GITHUB_STEP_SUMMARY
          echo "- Artifacts uploaded for SBOM generation" >> $GITHUB_STEP_SUMMARY


  # --------------------------------------------------
  # 2ï¸âƒ£ Generate SBOM
  # --------------------------------------------------
  generate-sbom:
    name: ðŸ“¦ Generate SBOM
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-output
          path: target/

      - name: Generate SBOM (CycloneDX)
        run: |
          mvn -B org.cyclonedx:cyclonedx-maven-plugin:makeAggregateBom \
            -DoutputFormat=JSON \
            -DschemaVersion=1.6 \
            -DoutputName=demo-app.1.0.0.cdx
          echo "Generated SBOM:"
        shell: bash

      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: generated-sbom
          path: target/demo-app.1.0.0.cdx.json

      - name: Add Job Summary
        run: |
          echo "### ðŸ“¦ SBOM Generated" >> $GITHUB_STEP_SUMMARY
          echo "- CycloneDX SBOM created for build artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Uploaded as artifact [generated-sbom]" >> $GITHUB_STEP_SUMMARY


  # --------------------------------------------------
  # 3ï¸âƒ£ Sign SBOM
  # --------------------------------------------------
  sign-sbom:
    name: ðŸ” Sign SBOM
    runs-on: ubuntu-latest
    needs: generate-sbom

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Download Generated SBOM
        uses: actions/download-artifact@v4
        with:
          name: generated-sbom

      - name: Sign SBOM
        uses: shiftleftcyber/secure-sbom-action@v1.3.1
        with:
          sbom_file: demo-app.1.0.0.cdx.json
          secure_sbom_action: sign
          api_key: ${{ secrets.SECURE_SBOM_API_KEY }}
          key_id: ${{ secrets.SECURE_SBOM_KEYID }}

      - name: Upload Signed SBOM
        uses: actions/upload-artifact@v4
        with:
          name: signed-sbom
          path: demo-app.1.0.0.cdx.signed.json

      - name: Add Job Summary
        run: |
          echo "### ðŸ” SBOM Signed" >> $GITHUB_STEP_SUMMARY
          echo "- SBOM signed using SecureSBOM API" >> $GITHUB_STEP_SUMMARY
          echo "- Signed artifact uploaded [signed-sbom]" >> $GITHUB_STEP_SUMMARY


  # --------------------------------------------------
  # 4ï¸âƒ£ Tamper SBOM (Simulate Attacker)
  # --------------------------------------------------
  tamper-sbom:
    name: âš ï¸ Tamper SBOM (Simulate Attacker)
    runs-on: ubuntu-latest
    needs: sign-sbom

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Download Signed SBOM
        uses: actions/download-artifact@v4
        with:
          name: signed-sbom

      - name: Tamper with SBOM (Modify Log4J version)
        run: |
          echo "Simulating malicious modification..."
          cp demo-app.1.0.0.cdx.signed.json tampered-demo-app.1.0.0.cdx.signed.json

          # Change the Log4J version in the SBOM to pretend it's patched
          sed -i 's/2\\.14\\.1/2.20.0/g' tampered-demo-app.1.0.0.cdx.signed.json

          echo "Tampered SBOM created (Log4J version changed)"
          cat tampered-demo-app.1.0.0.cdx.signed.json | head -n 15

      - name: Upload Tampered SBOM
        uses: actions/upload-artifact@v4
        with:
          name: tampered-sbom
          path: tampered-demo-app.1.0.0.cdx.signed.json

      - name: Add Job Summary
        run: |
          echo "### âš ï¸ Tamper Simulation" >> $GITHUB_STEP_SUMMARY
          echo "- SBOM was modified after signing" >> $GITHUB_STEP_SUMMARY
          echo "- Log4J version changed to simulate tampering attempt" >> $GITHUB_STEP_SUMMARY
          echo "- Uploaded as artifact [tampered-sbom]" >> $GITHUB_STEP_SUMMARY


  # --------------------------------------------------
  # 5ï¸âƒ£ Verify (Tampered) SBOM
  # --------------------------------------------------
  verify-sbom:
    name: âŒ Verify Tampered SBOM
    runs-on: ubuntu-latest
    needs: tamper-sbom

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Download Tampered SBOM
        uses: actions/download-artifact@v4
        with:
          name: tampered-sbom

      - name: Verify Tampered SBOM
        id: verify
        uses: shiftleftcyber/secure-sbom-action@v1.3.1
        with:
          sbom_file: tampered-demo-app.1.0.0.cdx.signed.json
          secure_sbom_action: verify
          api_key: ${{ secrets.SECURE_SBOM_API_KEY }}
          key_id: ${{ secrets.SECURE_SBOM_KEYID }}

      - name: Enforce Security Gate (Fail if invalid)
        if: steps.verify.outcome != 'success'
        run: |
          echo "âŒ SBOM Verification Failed - Tampering Detected! Blocking Deployment."
          exit 1

      - name: Add Job Summary
        if: steps.verify.outcome != 'success'
        run: |
          echo "### âŒ SecureSBOM Verification Failed" >> $GITHUB_STEP_SUMMARY
          echo "- Tampered SBOM detected during verification" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”’ Security gate enforced: deployment blocked" >> $GITHUB_STEP_SUMMARY


  # --------------------------------------------------
  # 6ï¸âƒ£ Simulated Deployment (Blocked)
  # --------------------------------------------------
  deploy:
    name: ðŸš« Deployment Blocked
    runs-on: ubuntu-latest
    needs: verify-sbom
    if: always()

    steps:
      - name: Conditional Deployment Simulation
        run: |
          if [ "${{ needs.verify-sbom.result }}" == "success" ]; then
            echo "ðŸš€ Deployment Approved - SBOM integrity verified!"
          else
            echo "â›” Deployment Blocked - SBOM verification failed."
            exit 1
          fi

      - name: Add Job Summary
        run: |
          if [ "${{ needs.verify-sbom.result }}" == "success" ]; then
            echo "### ðŸš€ Deployment Simulated" >> $GITHUB_STEP_SUMMARY
            echo "- SBOM verification passed, deployment would proceed" >> $GITHUB_STEP_SUMMARY
          else
            echo "### â›” Deployment Blocked" >> $GITHUB_STEP_SUMMARY
            echo "- SBOM verification failed" >> $GITHUB_STEP_SUMMARY
            echo "- Build stopped by quality gate âŒ" >> $GITHUB_STEP_SUMMARY
